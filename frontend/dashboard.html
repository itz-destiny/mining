<!doctype html>
<html><head><meta charset="utf-8"><title>Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>User Dashboard</h1>
  <button id="logout">Logout</button>
  <h2>Account</h2>
  <pre id="acct"></pre>
  <h2>Linked Miners</h2>
  <ul id="miners"></ul>
  <h2>Live Hashrate (last 30 points)</h2>
  <canvas id="chart" width="600" height="200"></canvas>
<script>
const token = localStorage.getItem('token');
if (!token) { window.location='/login.html'; }
document.getElementById('logout').onclick = ()=>{ localStorage.removeItem('token'); window.location='/login.html'; }

async function loadAccount() {
  const r = await fetch('/api/user/me',{headers:{'Authorization':'Bearer '+token}});
  const j = await r.json();
  if (!j.ok) { alert('auth error'); window.location='/login.html'; return; }
  document.getElementById('acct').textContent = JSON.stringify(j.user, null, 2);
}
async function loadMiners() {
  const r = await fetch('/api/admin/miners',{headers:{'X-API-KEY': (localStorage.getItem('server_api_key')||'')}});
  const j = await r.json();
  const ul = document.getElementById('miners'); ul.innerHTML='';
  if (j.ok) {
    for (const m of j.miners) {
      const li = document.createElement('li');
      li.textContent = `${m.id} | balance=${m.balance} | shares=${m.shares}`;
      ul.appendChild(li);
    }
  }
}

let chart;
let dataPoints = [];
function initChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Hashrate', data: [] }] },
    options: { scales: { y: { beginAtZero:true } } }
  });
}

function addPoint(val) {
  if (dataPoints.length >= 30) dataPoints.shift();
  dataPoints.push(val);
  chart.data.labels = dataPoints.map((_,i)=>i);
  chart.data.datasets[0].data = dataPoints;
  chart.update();
}

function connectSSE() {
  const es = new EventSource('/api/stream');
  es.onmessage = (e) => {
    const d = JSON.parse(e.data);
    addPoint(d.hashrate || 0);
  };
}

window.onload = async () => { await loadAccount(); await loadMiners(); initChart(); connectSSE(); }
</script>
</body></html>
